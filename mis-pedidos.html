<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Al-Sahara • Mis pedidos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">
</head>
<body class="min-vh-100 d-flex flex-column">

  <nav class="bg-light border-bottom">
    <div class="container">
      <div class="d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
        <a class="navbar-brand fw-semibold text-decoration-none" href="index.html">Al-Sahara</a>
        <ul class="nav gap-2 flex-wrap mb-0">
          <li class="nav-item"><a class="nav-link px-2" href="catalogo.html">Catálogo</a></li>
          <li class="nav-item"><a class="nav-link px-2" href="carrito.html">Carrito</a></li>
          <li class="nav-item"><a class="nav-link px-2 active" href="mis-pedidos.html">Mis pedidos</a></li>
        </ul>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <div class="d-flex align-items-center gap-2 flex-wrap" id="navAuthArea"></div>
        </div>
      </div>
    </div>
  </nav>

  <main class="container my-4 flex-grow-1">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <h1 class="h4 mb-0">Mis pedidos</h1>
      <span class="small text-muted" id="ordersCountLabel">— pedidos</span>
    </div>
    <div id="ordersAlert" class="alert alert-danger d-none" role="alert"></div>
    <div id="ordersEmpty" class="alert alert-info d-none" role="alert">
      Aún no tienes pedidos registrados. Ve al <a href="catalogo.html" class="alert-link">catálogo</a> y realiza tu primera compra.
    </div>

    <div id="ordersList" class="vstack gap-3"></div>
  </main>

  <footer class="bg-light border-top mt-auto">
    <div class="container py-3 small d-flex flex-wrap justify-content-between gap-2">
      <span>© Al-Sahara</span>
      <nav class="d-flex gap-3">
        <a href="#" class="link-secondary text-decoration-none">Contacto</a>
        <a href="#" class="link-secondary text-decoration-none">Términos</a>
      </nav>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="api-client.js"></script>
  <script src="nav-auth.js"></script>
  <script src="order-utils.js"></script>

<script>
  (function () {
    const api = window.AlSaharaAPI || {};
    const ui  = window.AlSaharaUI || {};

    const { alSaharaFetch, getStoredUser, clearAuthSession } = api;
    const { getOrderTotal } = ui;
    const ordersAlert      = document.getElementById('ordersAlert');
    const ordersEmpty      = document.getElementById('ordersEmpty');
    const ordersList       = document.getElementById('ordersList');
    const ordersCountLabel = document.getElementById('ordersCountLabel');

    function formatCLP(n) {
      const num = Number(n) || 0;
      return new Intl.NumberFormat('es-CL', {
        style: 'currency',
        currency: 'CLP',
      }).format(num);
    }

    function mapStatus(status) {
      const map = {
        pending:   { label: 'Pendiente',   cls: 'warning' },
        paid:      { label: 'Pagado',      cls: 'success' },
        delivering:{ label: 'En reparto',  cls: 'info' },
        completed: { label: 'Completado',  cls: 'success' },
        cancelled: { label: 'Cancelado',   cls: 'secondary' },
        failed:    { label: 'Fallido',     cls: 'danger' },
        refunded:  { label: 'Reembolsado', cls: 'secondary' },
      };
      return map[status] || { label: status || 'Desconocido', cls: 'secondary' };
    }

    function mapDeliveryMethod(m) {
      const map = {
        delivery: 'Despacho a domicilio',
        pickup: 'Retiro en local',
      };
      return map[m] || '—';
    }

    function mapPaymentMethod(m) {
      const map = {
        card: 'Tarjeta',
        cash: 'Pago contra entrega',
        transbank: 'Tarjeta (Webpay)',
      };
      return map[m] || m || '—';
    }

    function showError(msg) {
      if (!ordersAlert) return;
      ordersAlert.textContent = msg;
      ordersAlert.classList.remove('d-none');
    }

    function clearError() {
      if (!ordersAlert) return;
      ordersAlert.classList.add('d-none');
      ordersAlert.textContent = '';
    }

    function renderOrders(orders) {
      if (!ordersList) return;
      ordersList.innerHTML = '';

      if (!orders || !orders.length) {
        ordersEmpty.classList.remove('d-none');
        ordersCountLabel.textContent = '0 pedidos';
        return;
      }

      ordersEmpty.classList.add('d-none');
      ordersCountLabel.textContent = `${orders.length} pedido${orders.length === 1 ? '' : 's'}`;

      orders.forEach((order) => {
        const id        = order._id || order.id;
        const createdAt = order.createdAt ? new Date(order.createdAt) : null;
        const status = mapStatus(order.status);

        const items = order.items || [];
        let subtotalCalc = 0;

        items.forEach((it) => {
          const price = Number(it.price ?? it.unitPrice ?? 0);
          const qty   = Number(it.quantity ?? 0);
          subtotalCalc += price * qty;
        });
        const deliveryFee = Number(order.deliveryFee || 0);
        const tipValue    = Number(order.tip || 0);
        const total = subtotalCalc + deliveryFee + tipValue || Number(order.total) || 0;

        const delivery  = mapDeliveryMethod(order.deliveryMethod);
        const payMethod = mapPaymentMethod(order.paymentInfo?.method || order.paymentMethod);
        const totalItems = items.reduce((acc, it) => acc + (it.quantity || 0), 0);

        const itemsPreview = items
          .slice(0, 3)
          .map((it) => it.name || it.productName || it.productId || '(Producto)')
          .join(', ');
        const moreCount = items.length > 3 ? ` + ${items.length - 3} más` : '';

        const fechaStr = createdAt
          ? createdAt.toLocaleString('es-CL', { dateStyle: 'short', timeStyle: 'short' })
          : '—';

        const card = document.createElement('article');
        card.className = 'card shadow-sm';

        card.innerHTML = `
          <div class="card-body d-flex flex-column flex-lg-row justify-content-between gap-3">
            <div class="flex-grow-1">
              <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
                <h2 class="h6 mb-0">Pedido ${id}</h2>
                <span class="badge text-bg-${status.cls}">${status.label}</span>
              </div>
              <div class="small text-muted mb-2">
                <span class="me-3"><strong>Fecha:</strong> ${fechaStr}</span>
                <span class="me-3"><strong>Ítems:</strong> ${totalItems}</span>
              </div>
              <div class="small">
                <div><strong>Entrega:</strong> ${delivery}</div>
                <div><strong>Método de pago:</strong> ${payMethod}</div>
                <div class="mt-1 text-truncate">
                  <strong>Productos:</strong> ${itemsPreview}${moreCount}
                </div>
              </div>
            </div>
            <div class="d-flex flex-column align-items-end justify-content-between gap-2">
              <div class="text-end">
                <div class="small text-muted">Total</div>
                <div class="fw-semibold fs-5">${formatCLP(total)}</div>
              </div>
              <div class="d-grid gap-2">
                <a href="comprobante.html?order=${encodeURIComponent(id)}" class="btn btn-sm btn-outline-primary">
                  Ver comprobante
                </a>
                <a href="catalogo.html" class="btn btn-sm btn-link text-decoration-none">
                  Volver al catálogo
                </a>
              </div>
            </div>
          </div>
        `;

        ordersList.appendChild(card);
      });
    }

    async function loadOrders() {
      clearError();
      const user = getStoredUser?.();
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      const userId    = user.id || user._id || null;
      const userEmail = user.email || null;

      try {
        const allOrders = await alSaharaFetch('/orders/mine', { method: 'GET' });

        const orders = allOrders.filter((o) => {
          const orderUserId    = (o.userId && o.userId.toString()) || null;
          const customerUserId = (o.customerUserId && o.customerUserId.toString()) || null;
          const customerEmail  = o.customerEmail || null;

          return (
            (userId    && (orderUserId === userId || customerUserId === userId)) ||
            (userEmail && customerEmail === userEmail)
          );
        });

        renderOrders(orders);
      } catch (err) {
        console.error('Error cargando pedidos', err);
        if (err.status === 401 || err.status === 403) {
          clearAuthSession?.();
          window.location.href = 'login.html';
        } else {
          showError(err.message || 'No se pudieron cargar tus pedidos.');
        }
      }
    }


    document.addEventListener('DOMContentLoaded', loadOrders);
  })();
</script>
