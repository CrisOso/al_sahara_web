<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Recuperar contraseña • Al-Sahara</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
  <nav class="bg-light border-bottom">
    <div class="container">
      <div class="d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
        <a class="navbar-brand fw-semibold text-decoration-none" href="index.html">Al-Sahara</a>
        <ul class="nav gap-2 flex-wrap mb-0">
          <li class="nav-item"><a class="nav-link px-2" href="catalogo.html">Catálogo</a></li>
          <li class="nav-item"><a class="nav-link px-2" href="carrito.html">Carrito</a></li>
          <li class="nav-item"><a class="nav-link px-2" href="mis-pedidos.html">Mis pedidos</a></li>
        </ul>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <div class="d-flex align-items-center gap-2 flex-wrap" id="navAuthArea"></div>
        </div>
      </div>
    </div>
  </nav>
<main class="container my-5">
  <div class="row justify-content-center">
    <div class="col-12 col-md-6 col-lg-5">

      <!-- BLOQUE 1: pedir código de recuperación -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h1 class="h4 mb-3">Recuperar contraseña</h1>
          <div id="recoverAlert" class="alert alert-danger d-none" role="alert"></div>

          <form class="vstack gap-3" onsubmit="return handleRecover(event)">
            <div>
              <label class="form-label" for="recoverEmail">Correo</label>
              <input
                id="recoverEmail"
                type="email"
                class="form-control"
                placeholder="tu@correo.com"
                autocomplete="email"
                required
              >
            </div>

            <button class="btn btn-primary w-100" id="btnRecover" type="submit">
              Enviar código
            </button>
          </form>

          <p class="small mt-3 mb-0">
            Te enviaremos un código de recuperación (en este entorno de prueba aparecerá en los logs del servidor).
          </p>
        </div>
      </div>

      <!-- BLOQUE 2: usar código + nueva contraseña -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5 mb-3">Restablecer contraseña</h2>
          <div id="resetAlert" class="alert alert-danger d-none" role="alert"></div>

          <form class="vstack gap-3" onsubmit="return handleReset(event)">
            <div>
              <label class="form-label" for="resetToken">Código de recuperación</label>
              <input
                id="resetToken"
                type="text"
                class="form-control"
                placeholder="Pega aquí el código recibido"
                autocomplete="one-time-code"
                required
              >
            </div>

            <div>
              <label class="form-label" for="resetPass">Nueva contraseña</label>
              <input
                id="resetPass"
                type="password"
                class="form-control"
                autocomplete="new-password"
                minlength="6"
                required
              >
            </div>

            <div>
              <label class="form-label" for="resetPass2">Repetir nueva contraseña</label>
              <input
                id="resetPass2"
                type="password"
                class="form-control"
                autocomplete="new-password"
                minlength="6"
                required
              >
            </div>

            <button class="btn btn-success w-100" id="btnReset" type="submit">
              Cambiar contraseña
            </button>
          </form>

          <p class="small mt-3 mb-0">
            ¿Ya recordaste tu contraseña? <a href="login.html">Volver a iniciar sesión</a>
          </p>
        </div>
      </div>

    </div>
  </div>
</main>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="api-client.js"></script>
<script src="nav-auth.js"></script>
<script>
  const { alSaharaFetch, setAuthSession } = window.AlSaharaAPI;

  function showAlert(id, msg, type = 'danger') {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = msg;
    el.classList.remove('d-none');
    el.classList.add('show');
    el.classList.remove('alert-danger', 'alert-success', 'alert-warning', 'alert-info');
    el.classList.add('alert-' + type);
  }

  function clearAlert(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.add('d-none');
    el.classList.remove('show');
    el.textContent = '';
  }

  // Enviar correo / generar token
  async function handleRecover(event) {
    event.preventDefault();
    clearAlert('recoverAlert');

    const email = (document.getElementById('recoverEmail')?.value || '')
      .trim()
      .toLowerCase();
    if (!email) {
      showAlert('recoverAlert', 'Ingresa un correo válido.');
      return false;
    }

    const btn = document.getElementById('btnRecover');
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Enviando...';
    }

    try {
      const data = await alSaharaFetch('/auth/recover', {
        method: 'POST',
        body: JSON.stringify({ email }),
      });

      showAlert(
        'recoverAlert',
        data?.message || 'Si el correo existe, se ha enviado un email de recuperación.',
        'success'
      );
    } catch (err) {
      console.error('Error en recover:', err);
      showAlert(
        'recoverAlert',
        err.message || 'Error al generar el código de recuperación.'
      );
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Enviar código';
      }
    }

    return false;
  }

  // Usar token + nueva contraseña
  async function handleReset(event) {
    event.preventDefault();
    clearAlert('resetAlert');

    const token = (document.getElementById('resetToken')?.value || '').trim();
    const pass = (document.getElementById('resetPass')?.value || '').trim();
    const pass2 = (document.getElementById('resetPass2')?.value || '').trim();

    if (!token || !pass || !pass2) {
      showAlert('resetAlert', 'Completa todos los campos.');
      return false;
    }

    if (pass.length < 6) {
      showAlert('resetAlert', 'La contraseña debe tener al menos 6 caracteres.');
      return false;
    }

    if (pass !== pass2) {
      showAlert('resetAlert', 'Las contraseñas no coinciden.');
      return false;
    }

    const btn = document.getElementById('btnReset');
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Actualizando...';
    }

    try {
      const data = await alSaharaFetch('/auth/reset-password', {
        method: 'POST',
        body: JSON.stringify({ token, newPassword: pass }),
      });

      // Guardar sesión inmediatamente
      if (data?.token && data?.user) {
        setAuthSession(data.token, data.user);
      }

      showAlert(
        'resetAlert',
        data?.message || 'Contraseña actualizada correctamente.',
        'success'
      );

      // Redirigir igual que registro: al inicio (podrías enviarlo a usuario.html si prefieres)
      setTimeout(() => {
        const role = data?.user?.role || 'customer';
        if (role === 'admin') {
          window.location.href = 'admin.html';
        } else {
          window.location.href = 'index.html';
        }
      }, 1500);
    } catch (err) {
      console.error('Error en reset-password:', err);
      showAlert(
        'resetAlert',
        err.message || 'Error al actualizar la contraseña.'
      );
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'Cambiar contraseña';
      }
    }

    return false;
  }

  window.handleRecover = handleRecover;
  window.handleReset = handleReset;
</script>
</body>
</html>
