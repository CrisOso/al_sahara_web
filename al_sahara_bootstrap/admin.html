<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin • Al-Sahara</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">
</head>
<body>

<nav class="bg-light border-bottom">
  <div class="container">
    <div class="d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
      <a class="navbar-brand fw-semibold text-decoration-none" href="index.html">Al‑Sahara</a>
      <ul class="nav gap-2 flex-wrap mb-0">
        <li class="nav-item"><a class="nav-link px-2" href="catalogo.html">Catálogo</a></li>
        <li class="nav-item"><a class="nav-link px-2" href="carrito.html">Carrito</a></li>
      </ul>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2 flex-wrap" id="navAuthArea"></div>
        <a id="navLogout" class="btn btn-sm btn-outline-danger d-none" href="#">Salir</a>
      </div>
    </div>
  </div>
</nav>

<div class="container py-3">
  <h1 class="h3 mb-3">Panel de administración</h1>

  <nav class="mb-3">
    <ul class="nav gap-2 flex-wrap">
      <li class="nav-item"><a class="btn btn-sm btn-primary" href="admin.html">Panel</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="catalogo-admin.html">Productos</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="usuarios-admin.html">Usuarios</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="reportes-admin.html">Reportes</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="operaciones-admin.html">Operaciones</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="anulaciones-admin.html">Anulaciones</a></li>
    </ul>
  </nav>

  <div class="row g-3">
    <!-- ÓRDENES DEL DÍA -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Total ventas del día</h5>
          <p class="card-text fs-3 fw-bold mb-1" id="ordersTodayAmount">$0</p>
          <p class="small mb-0">
            Órdenes del día
            <span class="fw-semibold" id="ordersToday">—</span>
          </p>
          <p class="small text-muted mt-1">Órdenes generadas en la fecha de hoy.</p>
        </div>
      </div>
    </div>

    <!-- PRODUCTOS BAJO STOCK -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Productos con bajo stock</h5>
          <ul id="lowStockList" class="small mb-0"></ul>
        </div>
      </div>
    </div>

    <!-- PRODUCTOS MÁS / MENOS VENDIDOS -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Ventas</h5>
          <p class="small mb-1"><strong>Más vendido:</strong> <span id="bestProduct">—</span></p>
          <p class="small"><strong>Menos vendido:</strong> <span id="worstProduct">—</span></p>
        </div>
      </div>
    </div>
  </div>
</div>


<footer class="border-top">
  <div class="container d-flex flex-wrap justify-content-between align-items-center py-3 gap-2">
    <a href="contacto.html" class="text-decoration-none">Contacto</a>
    <span class="small text-muted">© 2025 Al-Sahara</span>
  </div>
</footer>

<script src="api-client.js"></script>
<script src="nav-auth.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const api = window.AlSaharaAPI;
  if (!api) return;

  const ordersTodayEl      = document.getElementById('ordersToday');
  const ordersTodayAmountEl = document.getElementById('ordersTodayAmount');
  const lowStockListEl     = document.getElementById('lowStockList');
  const bestProductEl      = document.getElementById('bestProduct');
  const worstProductEl     = document.getElementById('worstProduct');

  function formatCLP(n) {
    const num = Number(n) || 0;
    return new Intl.NumberFormat('es-CL', {
      style: 'currency',
      currency: 'CLP',
    }).format(num);
  }

  try {
    // 1. Obtener todas las órdenes (admin)
    const allOrders = await api.alSaharaFetch('/orders');
    const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

    const ordersToday = allOrders.filter(o =>
      o.createdAt && o.createdAt.slice(0, 10) === today
    );

    // Cantidad de órdenes del día
    ordersTodayEl.textContent = ordersToday.length;

    // Monto total vendido en el día
    let totalToday = 0;
    ordersToday.forEach(o => {
      let subtotal = 0;
      (o.items || []).forEach(it => {
        const price = Number(it.price ?? it.unitPrice ?? 0);
        const qty   = Number(it.quantity ?? 0);
        subtotal += price * qty;
      });

      const deliveryFee = Number(o.deliveryFee || 0);
      const tip         = Number(o.tip || 0);
      const totalOrder  = Number(o.total) || (subtotal + deliveryFee + tip);

      totalToday += totalOrder;
    });

    if (ordersTodayAmountEl) {
      ordersTodayAmountEl.textContent = formatCLP(totalToday);
    }

    // 2. Productos con bajo stock
    const products = await api.alSaharaFetch('/products');

    const lowStock = products.filter(p => Number(p.stock) < 10);

    if (!lowStock.length) {
      lowStockListEl.innerHTML = "<li class='text-muted'>Sin alertas de stock</li>";
    } else {
      lowStockListEl.innerHTML = lowStock
        .map(p => `<li>${p.name} — Stock: ${p.stock}</li>`)
        .join('');
    }

    // 3. Producto más y menos vendido
    const salesMap = {};

    allOrders.forEach(order => {
      (order.items || []).forEach(item => {
        const name = item.name || item.productName || item.productId || '(Producto)';
        const qty  = Number(item.quantity || 0);
        if (!salesMap[name]) salesMap[name] = 0;
        salesMap[name] += qty;
      });
    });

    const entries = Object.entries(salesMap);

    if (!entries.length) {
      bestProductEl.textContent  = '—';
      worstProductEl.textContent = '—';
    } else {
      const sorted = entries.sort((a, b) => b[1] - a[1]);
      const [bestName, bestQty]   = sorted[0];
      const [worstName, worstQty] = sorted[sorted.length - 1];

      bestProductEl.textContent  = `${bestName} (${bestQty} uds.)`;
      worstProductEl.textContent = `${worstName} (${worstQty} uds.)`;
    }

  } catch (err) {
    console.error('[ADMIN DASHBOARD ERROR]', err);
  }
});
</script>


</body>
</html>