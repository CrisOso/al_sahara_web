<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Reportes • Al-Sahara</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">
</head>
<body>

<nav class="bg-light border-bottom">
  <div class="container">
    <div class="d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
      <a class="navbar-brand fw-semibold text-decoration-none" href="index.html">Al‑Sahara</a>
      <ul class="nav gap-2 flex-wrap mb-0">
        <li class="nav-item"><a class="nav-link px-2" href="catalogo.html">Catálogo</a></li>
        <li class="nav-item"><a class="nav-link px-2" href="carrito.html">Carrito</a></li>
      </ul>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2 flex-wrap" id="navAuthArea"></div>
        <a id="navLogout" class="btn btn-sm btn-outline-danger d-none" href="#">Salir</a>
      </div>
    </div>
  </div>
</nav>

<div class="container py-3">
  <h1 class="h3 mb-3">Reportes</h1>
  <nav class="mb-3">
    <ul class="nav gap-2 flex-wrap">
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="admin.html">Panel</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="catalogo-admin.html">Productos</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="usuarios-admin.html">Usuarios</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-primary" href="reportes-admin.html">Reportes</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="operaciones-admin.html">Operaciones</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="anulaciones-admin.html">Anulaciones</a></li>
    </ul>
  </nav>
<div class="container">

  <div class="card">
    <div class="p">
      <div class="row">
        <div class="col-4">
          <label>Desde</label>
          <input type="date" id="f_desde">
        </div>
        <div class="col-4">
          <label>Hasta</label>
          <input type="date" id="f_hasta">
        </div>
        <div class="col-4">
          <button class="btn btn-sm btn-outline-primary" id="btnFiltrar">Filtrar</button>
        </div>
      </div>

      <table id="tablaRep" class="table table-sm">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Orden</th>
            <th>Cliente</th>
            <th>Estado</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="row">
        <div class="col-6">
          <div class="card">
            <div class="p d-flex align-items-center gap-2">
              <div class="small">Total órdenes:</div>
              <div id="repCount" class="fw-semibold">0</div>
            </div>
          </div>
        </div>

        <div class="col-6">
          <div class="card">
            <div class="p d-flex align-items-center gap-2">
              <div class="small">Ventas estimadas</div>
              <div id="repTotal" class="fw-semibold">$0</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="p">
      <div class="d-flex justify-content-between align-items-center">
        <h3>Ventas por día</h3>
        <button class="btn" id="repDiaCSV">Exportar Excel</button>
      </div>

      <div id="repDiaInfo" class="small"></div>

      <table id="repDiaTable" class="table table-sm">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Órdenes</th>
            <th>Total</th>
            <th>Gráfico</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="p">
      <div class="d-flex justify-content-between align-items-center">
        <h3>Ventas por método de pago</h3>
        <button class="btn" id="repPagoCSV">Exportar Excel</button>
      </div>

      <table id="repPagoTable" class="table table-sm">
        <thead>
          <tr>
            <th>Método</th>
            <th>Órdenes</th>
            <th>Total</th>
            <th>Gráfico</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="p">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Top productos</h3>
        <button class="btn" id="repTopCSV">Exportar Excel</button>
      </div>

      <table id="repTopTable" class="table table-sm">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Unidades</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
</div>

<footer class="border-top">
  <div class="container d-flex flex-wrap justify-content-between align-items-center py-3 gap-2">
    <a href="contacto.html" class="text-decoration-none">Contacto</a>
    <span class="small text-muted">© 2025 Al-Sahara</span>
  </div>
</footer>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="api-client.js"></script>
<script src="nav-auth.js"></script>
<script>
  (function () {
    const api = window.AlSaharaAPI || {};
    const { alSaharaFetch, clearAuthSession } = api;

    const fDesde     = document.getElementById('f_desde');
    const fHasta     = document.getElementById('f_hasta');
    const btnFiltrar = document.getElementById('btnFiltrar');

    const tablaRepBody = document.querySelector('#tablaRep tbody');
    const repCount     = document.getElementById('repCount');
    const repTotal     = document.getElementById('repTotal');

    const repDiaInfo   = document.getElementById('repDiaInfo');
    const repDiaTable  = document.querySelector('#repDiaTable tbody');
    const repDiaCSV    = document.getElementById('repDiaCSV');

    const repPagoTable = document.querySelector('#repPagoTable tbody');
    const repPagoCSV   = document.getElementById('repPagoCSV');

    const repTopTable  = document.querySelector('#repTopTable tbody');
    const repTopCSV    = document.getElementById('repTopCSV');

    let allOrders      = [];
    let filteredOrders = [];
    let lastDailyData  = [];
    let lastPagoData   = [];
    let lastTopData    = [];

    const STATUS_MAP = {
      pending:    'Pendiente',
      paid:       'Pagado',
      delivering: 'En reparto',
      completed:  'Completado',
      cancelled:  'Cancelado',
      refunded:   'Reembolsado',
      failed:     'Fallido',
    };

    const PAYMENT_MAP = {
      card: 'Tarjeta',
      cash: 'Efectivo',
      transfer: 'Transferencia',
    };

    function formatCLP(n) {
      const num = Number(n) || 0;
      return new Intl.NumberFormat('es-CL', {
        style: 'currency',
        currency: 'CLP',
      }).format(num);
    }

    function getDateOnly(iso) {
      if (!iso) return null;
      return iso.slice(0, 10);
    }

    function setDefaultDates() {
      const today = new Date();
      const toStr = today.toISOString().slice(0, 10);

      const from = new Date(today);
      from.setDate(from.getDate() - 7);
      const fromStr = from.toISOString().slice(0, 10);

      if (fHasta && !fHasta.value) fHasta.value = toStr;
      if (fDesde && !fDesde.value) fDesde.value = fromStr;
    }

    function applyDateFilter() {
      const from = fDesde?.value || null;
      const to   = fHasta?.value || null;

      return allOrders.filter((o) => {
        const d = getDateOnly(o.createdAt);
        if (!d) return false;
        if (from && d < from) return false;
        if (to   && d > to)   return false;
        return true;
      });
    }

    function renderOrdersTable(orders) {
      if (!tablaRepBody) return;
      tablaRepBody.innerHTML = '';

      let sumTotal = 0;

      orders.forEach((o) => {
        const tr = document.createElement('tr');
        const d  = getDateOnly(o.createdAt) || '';

        const cliente =
          o.customerName ||
          o.customerEmail ||
          (o.customerUserId ? `Usuario ${o.customerUserId}` : '-');

        const estado = STATUS_MAP[o.status] || o.status || '-';
        const total  = Number(o.total) || 0;
        sumTotal += total;

        // Probar varios posibles nombres de ID
        const orderId = o.id || o._id || o.orderId || '—';

        tr.innerHTML = `
          <td>${d}</td>
          <td>${orderId}</td>
          <td>${cliente}</td>
          <td>${estado}</td>
          <td>${formatCLP(total)}</td>
        `;
        tablaRepBody.appendChild(tr);
      });

      if (repCount) {
        repCount.textContent = orders.length.toString();
      }
      if (repTotal) {
        repTotal.textContent = formatCLP(sumTotal);
      }
    }

    function renderDailySales(orders) {
      if (!repDiaTable) return;
      repDiaTable.innerHTML = '';
      lastDailyData = [];

      const grouped = new Map();
      for (const o of orders) {
        const d = getDateOnly(o.createdAt);
        if (!d) continue;
        if (!grouped.has(d)) {
          grouped.set(d, { date: d, orders: 0, total: 0 });
        }
        const g = grouped.get(d);
        g.orders += 1;
        g.total += Number(o.total) || 0;
      }

      const rows = Array.from(grouped.values()).sort((a, b) =>
        a.date.localeCompare(b.date)
      );
      lastDailyData = rows;

      const maxTotal = rows.reduce((m, r) => Math.max(m, r.total), 0) || 1;

      rows.forEach((r) => {
        const tr = document.createElement('tr');
        const width = Math.max(5, (r.total / maxTotal) * 100); // mínimo 5%

        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.orders}</td>
          <td>${formatCLP(r.total)}</td>
          <td>
            <div class="bg-primary" style="height:0.75rem; width:${width}%;"></div>
          </td>
        `;
        repDiaTable.appendChild(tr);
      });

      if (repDiaInfo) {
        const totalOrders = orders.length;
        const totalAmount = rows.reduce((acc, r) => acc + r.total, 0);
        repDiaInfo.textContent = `Mostrando ${rows.length} día(s), ${totalOrders} orden(es), total ${formatCLP(totalAmount)}.`;
      }
    }

    function renderPaymentStats(orders) {
      if (!repPagoTable) return;
      repPagoTable.innerHTML = '';
      lastPagoData = [];

      const grouped = new Map();
      for (const o of orders) {
        const method = o.paymentMethod || 'desconocido';
        if (!grouped.has(method)) {
          grouped.set(method, { method, orders: 0, total: 0 });
        }
        const g = grouped.get(method);
        g.orders += 1;
        g.total += Number(o.total) || 0;
      }

      const rows = Array.from(grouped.values());
      lastPagoData = rows;

      const maxTotal = rows.reduce((m, r) => Math.max(m, r.total), 0) || 1;

      rows.forEach((r) => {
        const label = PAYMENT_MAP[r.method] || r.method;
        const width = Math.max(5, (r.total / maxTotal) * 100);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${label}</td>
          <td>${r.orders}</td>
          <td>${formatCLP(r.total)}</td>
          <td><div class="bg-success" style="height:0.75rem; width:${width}%;"></div></td>
        `;
        repPagoTable.appendChild(tr);
      });
    }

    function renderTopProducts(orders) {
      if (!repTopTable) return;
      repTopTable.innerHTML = '';
      lastTopData = [];

      const stats = new Map();
      for (const o of orders) {
        if (!Array.isArray(o.items)) continue;
        for (const item of o.items) {
          const id   = item.productId || item.id || 'unknown';
          const name = item.productName || item.name || `Producto ${id}`;
          const qty  = Number(item.quantity) || 0;
          if (!stats.has(id)) {
            stats.set(id, { productId: id, name, units: 0 });
          }
          const s = stats.get(id);
          s.units += qty;
        }
      }

      const rows = Array.from(stats.values())
        .sort((a, b) => b.units - a.units)
        .filter((r) => r.units > 0);

      lastTopData = rows;

      rows.forEach((r) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.units}</td>
        `;
        repTopTable.appendChild(tr);
      });
    }

    function exportCSV(filename, headers, rows) {
      if (!rows || rows.length === 0) return;

      const escape = (val) => {
        if (val == null) return '';
        const s = String(val);
        if (s.includes('"') || s.includes(',') || s.includes('\n')) {
          return '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
      };

      const lines = [];
      if (headers && headers.length) {
        lines.push(headers.map(escape).join(','));
      }
      rows.forEach((row) => {
        lines.push(row.map(escape).join(','));
      });

      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function bindCSVButtons() {
      if (repDiaCSV) {
        repDiaCSV.addEventListener('click', () => {
          const rows = lastDailyData.map((r) => [
            r.date,
            r.orders,
            r.total,
          ]);
          exportCSV('ventas_por_dia.csv', ['Fecha', 'Órdenes', 'Total'], rows);
        });
      }

      if (repPagoCSV) {
        repPagoCSV.addEventListener('click', () => {
          const rows = lastPagoData.map((r) => [
            PAYMENT_MAP[r.method] || r.method,
            r.orders,
            r.total,
          ]);
          exportCSV(
            'ventas_por_metodo_pago.csv',
            ['Método', 'Órdenes', 'Total'],
            rows
          );
        });
      }

      if (repTopCSV) {
        repTopCSV.addEventListener('click', () => {
          const rows = lastTopData.map((r) => [r.name, r.units]);
          exportCSV('top_productos.csv', ['Producto', 'Unidades'], rows);
        });
      }
    }

    function renderAll() {
      filteredOrders = applyDateFilter();
      renderOrdersTable(filteredOrders);
      renderDailySales(filteredOrders);
      renderPaymentStats(filteredOrders);
      renderTopProducts(filteredOrders);
    }

    async function loadOrders() {
      try {
        const orders = await alSaharaFetch('/orders');
        allOrders = Array.isArray(orders) ? orders : [];
        renderAll();
      } catch (err) {
        console.error('Error al cargar órdenes:', err);
        if (err.status === 401 || err.status === 403) {
          clearAuthSession();
          window.location.href = 'login.html';
        } else {
          alert(err.message || 'Error al cargar órdenes para reportes.');
        }
      }
    }

    function bindFilters() {
      if (btnFiltrar) {
        btnFiltrar.addEventListener('click', () => {
          renderAll();
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      setDefaultDates();
      bindFilters();
      bindCSVButtons();
      loadOrders();
    });
  })();
</script>

</body></html>