<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Operaciones • Al-Sahara</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">
</head>
<body>

<nav class="bg-light border-bottom">
  <div class="container">
    <div class="d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
      <a class="navbar-brand fw-semibold text-decoration-none" href="index.html">Al-Sahara</a>
      <ul class="nav gap-2 flex-wrap mb-0">
        <li class="nav-item"><a class="nav-link px-2" href="catalogo.html">Catálogo</a></li>
        <li class="nav-item"><a class="nav-link px-2" href="carrito.html">Carrito</a></li>
      </ul>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2 flex-wrap" id="navAuthArea"></div>
        <a id="navLogout" class="btn btn-sm btn-outline-danger d-none" href="#">Salir</a>
      </div>
    </div>
  </div>
</nav>

<div class="container py-3">
  <h1 class="h3 mb-3">Operaciones</h1>
  <nav class="mb-3">
    <ul class="nav gap-2 flex-wrap">
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="admin.html">Panel</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="catalogo-admin.html">Productos</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="usuarios-admin.html">Usuarios</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="reportes-admin.html">Reportes</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-primary" href="operaciones-admin.html">Operaciones</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="anulaciones-admin.html">Anulaciones</a></li>
    </ul>
  </nav>

  <div class="row g-2 mb-3">
    <div class="col-12 col-md-4">
      <select id="filtroEstado" class="form-select form-select-sm">
        <option value="">Todos los estados</option>
        <option value="pending">Pendiente</option>
        <option value="paid">Pagado</option>
        <option value="delivering">En reparto</option>
        <option value="completed">Completado</option>
        <option value="cancelled">Cancelado</option>
        <option value="failed">Fallido</option>
        <option value="refunded">Reembolsado</option>
      </select>
    </div>
    <div class="col-12 col-md-4">
      <input id="filtroTexto" class="form-control form-control-sm"
             placeholder="Buscar por #pedido, cliente o correo">
    </div>
  </div>

  <div class="accordion" id="acPedidos"></div>
</div>

<footer class="border-top">
  <div class="container d-flex flex-wrap justify-content-between align-items-center py-3 gap-2">
    <a href="contacto.html" class="text-decoration-none">Contacto</a>
    <span class="small text-muted">© 2025 Al-Sahara</span>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="app.js"></script>
<script src="api-client.js"></script>
<script src="nav-auth.js"></script>
<script>
  (function () {
    const api = window.AlSaharaAPI || {};
    const { alSaharaFetch, getStoredUser } = api;

    const acPedidos = document.getElementById('acPedidos');
    const filtroEstado = document.getElementById('filtroEstado');
    const filtroTexto = document.getElementById('filtroTexto');

    // Mapeo de estados internos -> etiqueta + color bootstrap
    const STATUS_MAP = {
      pending:    { label: 'Pendiente',    className: 'secondary' },
      paid:       { label: 'Pagado',       className: 'primary' },
      delivering: { label: 'En reparto',   className: 'info' },
      completed:  { label: 'Completado',   className: 'success' },
      cancelled:  { label: 'Cancelado',    className: 'warning' },
      failed:     { label: 'Fallido',      className: 'danger' },
      refunded:   { label: 'Reembolsado',  className: 'secondary' },
    };

    function mapStatus(status) {
      return STATUS_MAP[status] || { label: status || 'Desconocido', className: 'secondary' };
    }

    function formatCLP(n) {
      const num = Number(n) || 0;
      return new Intl.NumberFormat('es-CL', {
        style: 'currency',
        currency: 'CLP',
      }).format(num);
    }

    function statusOptionsMarkup(current) {
      const keys = ['pending', 'paid', 'delivering', 'completed', 'cancelled', 'failed', 'refunded'];
      return keys
        .map((key) => {
          const info = mapStatus(key);
          const sel = key === current ? 'selected' : '';
          return `<option value="${key}" ${sel}>${info.label}</option>`;
        })
        .join('');
    }

    let allOrders = [];

    async function loadOrders() {
      const user = getStoredUser && getStoredUser();

      if (!user || user.role !== 'admin') {
        if (acPedidos) {
          acPedidos.innerHTML = `
            <div class="alert alert-warning">
              Debes iniciar sesión como <strong>administrador</strong> para ver los pedidos.<br>
              <a href="login.html" class="alert-link">Ir a login</a>
            </div>`;
        }
        return;
      }

      if (!alSaharaFetch) {
        if (acPedidos) {
          acPedidos.innerHTML = `
            <div class="alert alert-danger">
              API no disponible en este entorno.
            </div>`;
        }
        return;
      }

      try {
        const orders = await alSaharaFetch('/orders', { method: 'GET' });
        allOrders = Array.isArray(orders) ? orders : [];
        render(applyFilters());
      } catch (e) {
        console.error('Error cargando pedidos admin', e);
        if (acPedidos) {
          acPedidos.innerHTML = `
            <div class="alert alert-danger">
              No se pudieron cargar los pedidos. Intenta nuevamente más tarde.
            </div>`;
        }
      }
    }

    function applyFilters() {
      const est = filtroEstado ? filtroEstado.value : '';
      const txt = filtroTexto ? filtroTexto.value.trim().toLowerCase() : '';

      return allOrders.filter((o) => {
        const okEst = !est || o.status === est;

        const blob = `${o.id || o._id} ${o.customerName || ''} ${o.customerEmail || ''}`.toLowerCase();
        const okTxt = !txt || blob.includes(txt);

        return okEst && okTxt;
      });
    }
    
  async function patchOrderStatus(id, newStatus) {
    try {
      await alSaharaFetch(`/orders/${encodeURIComponent(id)}/status`, {
        method: 'PATCH',
        body: { status: newStatus },
      });

      const o = allOrders.find((x) => (x.id || x._id) === id);
      if (o) o.status = newStatus;

      render(applyFilters());
    } catch (e) {
      console.error('Error actualizando estado pedido', e);
      alert('No se pudo actualizar el estado del pedido.');
    }
  }


  function render(list) {
    if (!acPedidos) return;

    if (!list.length) {
      acPedidos.innerHTML = `
        <div class="alert alert-info">
          No hay pedidos para los filtros seleccionados.
        </div>`;
      return;
    }

    const html = list.map((o, idx) => {
      const headId     = `order-head-${idx}`;
      const collapseId = `order-collapse-${idx}`;
      const statusInfo = mapStatus(o.status);

      const created = o.createdAt
        ? new Date(o.createdAt).toLocaleString('es-CL')
        : '';

      const customer = o.customerName || '(sin nombre)';
      const email    = o.customerEmail || '';
      const phone    = o.customerPhone || '-';

      const id       = o.id || o._id;
      const totalFmt = formatCLP(o.total);

      const entrega =
        o.deliveryMethod === 'delivery'
          ? (o.address || '(sin dirección)')
          : 'Retiro en local';

      const numProductos = Array.isArray(o.items)
        ? o.items.reduce((acc, it) => acc + (it.quantity || 0), 0)
        : 0;

      // Texto “12/12/2012 15:45:32 -- 2 productos”
      const subHeader = `${created}${
        numProductos
          ? ` -- ${numProductos} producto${numProductos === 1 ? '' : 's'}`
          : ''
      }`;

      // Historial simple (puedes refinarlo después si guardas más timestamps)
      const historyLines = [
        `${created} : Nuevo`,
        o.status === 'paid'       ? `${created} : Pagado`       : null,
        o.status === 'delivering' ? `${created} : En preparación` : null,
        o.status === 'completed'  ? `${created} : Listo para retiro/entrega` : null,
      ].filter(Boolean);

      return `
  <div class="accordion-item">
    <h2 class="accordion-header" id="${headId}">
      <button class="accordion-button collapsed" type="button"
              data-bs-toggle="collapse" data-bs-target="#${collapseId}"
              aria-expanded="false" aria-controls="${collapseId}">
        <div class="d-flex flex-column flex-md-row w-100 justify-content-between align-items-md-center gap-2">
          <div>
            <div class="fw-semibold">Pedido ${id}</div>
            <div class="small text-muted">${subHeader}</div>
          </div>

          <div class="text-primary small fw-semibold text-md-center">
            Generar orden de despacho
          </div>

          <div class="text-md-end">
            <div class="fw-semibold">${totalFmt}</div>
            <span class="badge text-bg-${statusInfo.className}">
              ${statusInfo.label}
            </span>
          </div>
        </div>
      </button>
    </h2>

    <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headId}"
        data-bs-parent="#acPedidos">
      <div class="accordion-body">
        <div class="row g-3">
          <!-- Columna izquierda: Cliente / Teléfono / Dirección -->
          <div class="col-12 col-md-4">
            <p class="mb-1"><strong>Cliente:</strong> ${customer}</p>
            <p class="mb-1"><strong>Teléfono:</strong> ${phone}</p>
            <p class="mb-1"><strong>Dirección:</strong> ${entrega}</p>
          </div>

          <!-- Columna central: Estado + botones -->
          <div class="col-12 col-md-4 d-flex flex-column align-items-start align-items-md-center gap-2">
            <div>
              <span class="small text-muted d-block mb-1">Estado</span>
              <select class="form-select form-select-sm js-order-status" data-id="${id}">
                ${statusOptionsMarkup(o.status)}
              </select>
            </div>
          </div>

          <!-- Columna derecha: Historial -->
          <div class="col-12 col-md-4">
            <div class="small text-muted mb-1">Historial</div>
            <ul class="small mb-0 list-unstyled">
              ${historyLines
                .map((line) => `<li>${line}</li>`)
                .join('')}
            </ul>
          </div>
        </div>

        <!-- Botón Ver detalle alineado abajo (opcional) -->
        <div class="mt-3 text-end">
          <a href="comprobante.html?id=${encodeURIComponent(id)}"
            class="btn btn-sm btn-outline-primary">
            Ver detalle
          </a>
        </div>
      </div>
    </div>
  </div>`;
    }).join('');

    acPedidos.innerHTML = html;

    // Select de estado
    acPedidos.querySelectorAll('.js-order-status').forEach((sel) => {
      sel.addEventListener('change', () => {
        const id        = sel.dataset.id;
        const newStatus = sel.value;
        patchOrderStatus(id, newStatus);
      });
    });

    // Botones "Marcar Despachado" y "Marcar Entregado"
    acPedidos.querySelectorAll('.js-mark-dispatched').forEach((btn) => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        patchOrderStatus(id, 'delivering');
      });
    });

    acPedidos.querySelectorAll('.js-mark-delivered').forEach((btn) => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        patchOrderStatus(id, 'completed');
      });
    });
  }


    if (filtroEstado) {
      filtroEstado.addEventListener('change', () => render(applyFilters()));
    }
    if (filtroTexto) {
      filtroTexto.addEventListener('input', () => render(applyFilters()));
    }

    document.addEventListener('DOMContentLoaded', loadOrders);
  })();
</script>
</body>
</html>
