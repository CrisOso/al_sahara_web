<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Anulaciones • Al-Sahara</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="styles.css" rel="stylesheet">
</head>
<body>
<nav class="bg-light border-bottom">
  <div class="container">
    <div class="d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
      <a class="navbar-brand fw-semibold text-decoration-none" href="index.html">Al‑Sahara</a>
      <ul class="nav gap-2 flex-wrap mb-0">
        <li class="nav-item"><a class="nav-link px-2" href="catalogo.html">Catálogo</a></li>
        <li class="nav-item"><a class="nav-link px-2" href="carrito.html">Carrito</a></li>
      </ul>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2 flex-wrap" id="navAuthArea"></div>
        <a id="navLogout" class="btn btn-sm btn-outline-danger d-none" href="#">Salir</a>
      </div>
    </div>
  </div>
</nav>

<div class="container py-3">
  <h1 class="h3 mb-3">Operaciones</h1>
  <nav class="mb-3">
    <ul class="nav gap-2 flex-wrap">
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="admin.html">Panel</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="catalogo-admin.html">Productos</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="usuarios-admin.html">Usuarios</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="reportes-admin.html">Reportes</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-outline-secondary" href="operaciones-admin.html">Operaciones</a></li>
      <li class="nav-item"><a class="btn btn-sm btn-primary" href="anulaciones-admin.html">Anulaciones</a></li>
    </ul>
  </nav>
<div class="card">
  <div class="p">
    <table id="tablaUsers" class="table table-sm">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Orden</th>
          <th>Cliente</th>
          <th>Teléfono</th>
          <th>Estado</th>
          <th>Total</th>
          <th>Acción</th>
          
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>
</div>

<footer class="border-top">
  <div class="container d-flex flex-wrap justify-content-between align-items-center py-3 gap-2">
    <a href="contacto.html" class="text-decoration-none">Contacto</a>
    <span class="small text-muted">© 2025 Al-Sahara</span>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="api-client.js"></script>
<script src="nav-auth.js"></script>
<script>
  (function () {
    const api = window.AlSaharaAPI || {};
    const { alSaharaFetch, getStoredUser, clearAuthSession } = api;

    const tbody = document.querySelector('#tablaUsers tbody');

    const STATUS_MAP = {
      pending:    { label: 'Pendiente',    className: 'secondary' },
      paid:       { label: 'Pagado',       className: 'primary' },
      delivering: { label: 'En reparto',   className: 'info' },
      completed:  { label: 'Completado',   className: 'success' },
      cancelled:  { label: 'Cancelado',    className: 'warning' },
      failed:     { label: 'Fallido',      className: 'danger' },
      refunded:   { label: 'Reembolsado',  className: 'secondary' },
    };

    const VISIBLE_STATUSES = ['pending', 'paid', 'delivering', 'completed'];

    function mapStatus(status) {
      const key = (status || '').toString().toLowerCase();
      return STATUS_MAP[key] || { label: status || 'Desconocido', className: 'secondary' };
    }

    function formatCLP(n) {
      const num = Number(n) || 0;
      return new Intl.NumberFormat('es-CL', {
        style: 'currency',
        currency: 'CLP',
      }).format(num);
    }

    function getClienteLabel(o) {
      return (
        o.customerName ||
        o.customerEmail ||
        (o.customerUserId ? 'Usuario ' + o.customerUserId : '-')
      );
    }

    // ID real para PATCH
    function getOrderId(o) {
      return o._id || o.id || null;
    }

    // Código visible en la tabla
    function getOrderCode(o) {
      return o.orderNumber || o._id || o.id || '-';
    }

    function showNotAdminMessage() {
      if (!tbody) return;
      const table = tbody.closest('table');
      if (table && table.parentElement) {
        table.parentElement.innerHTML = `
          <div class="p-3">
            <div class="alert alert-warning mb-0">
              Debes iniciar sesión como <strong>administrador</strong> para gestionar anulaciones.<br>
              <a href="login.html" class="alert-link">Ir a login</a>
            </div>
          </div>`;
      }
    }

    function showErrorMessage(msg) {
      if (!tbody) return;
      const table = tbody.closest('table');
      if (table && table.parentElement) {
        table.parentElement.innerHTML = `
          <div class="p-3">
            <div class="alert alert-danger mb-0">
              ${msg || 'No se pudieron cargar las órdenes.'}
            </div>
          </div>`;
      }
    }

    function renderRows(orders) {
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!orders.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td colspan="6" class="text-center text-muted py-3">
            No hay órdenes disponibles para anulación o reembolso.
          </td>`;
        tbody.appendChild(tr);
        return;
      }

      orders.forEach((o) => {
        const tr = document.createElement('tr');

        const orderId   = getOrderId(o);
        const orderCode = getOrderCode(o);
        const date      = o.createdAt
          ? new Date(o.createdAt).toLocaleString('es-CL', { dateStyle: 'short' })
          : (o.createdAt || '').slice(0, 10);

        const statusInfo = mapStatus(o.status);
        const total      = Number(o.total) || 0;

        const tdFecha = document.createElement('td');
        tdFecha.textContent = date;
        tr.appendChild(tdFecha);

        const tdOrden = document.createElement('td');
        tdOrden.textContent = orderCode;
        tr.appendChild(tdOrden);

        const tdCliente = document.createElement('td');
        tdCliente.textContent = getClienteLabel(o);
        tr.appendChild(tdCliente);

        const tdTelefono = document.createElement('td');
        tdTelefono.textContent = o.customerPhone || '-';
        tr.appendChild(tdTelefono);

        const tdEstado = document.createElement('td');
        tdEstado.innerHTML = `
          <span class="badge text-bg-${statusInfo.className}">
            ${statusInfo.label}
          </span>`;
        tr.appendChild(tdEstado);

        const tdTotal = document.createElement('td');
        tdTotal.textContent = formatCLP(total);
        tr.appendChild(tdTotal);

        const tdAccion = document.createElement('td');

        const rawStatus = (o.status || '').toLowerCase();
        const canCancel = ['pending', 'delivering', 'paid'].includes(rawStatus);
        const canRefund = ['paid', 'completed'].includes(rawStatus);

        if (!canCancel && !canRefund) {
          tdAccion.innerHTML = '<span class="text-muted">Sin acciones</span>';
        } else {
          if (canCancel) {
            const btnCancel = document.createElement('button');
            btnCancel.type = 'button';
            btnCancel.className = 'btn btn-sm btn-warning me-1';
            btnCancel.textContent = 'Anular';
            btnCancel.addEventListener('click', () =>
              handleChangeStatus(o, 'cancelled')
            );
            tdAccion.appendChild(btnCancel);
          }

          if (canRefund) {
            const btnRefund = document.createElement('button');
            btnRefund.type = 'button';
            btnRefund.className = 'btn btn-sm btn-outline-danger';
            btnRefund.textContent = 'Reembolsar';
            btnRefund.addEventListener('click', () =>
              handleChangeStatus(o, 'refunded')
            );
            tdAccion.appendChild(btnRefund);
          }
        }

        tr.appendChild(tdAccion);
        tbody.appendChild(tr);
      });
    }


    async function patchOrderStatus(orderId, newStatus) {
      try {
        return await alSaharaFetch(`/orders/${encodeURIComponent(orderId)}`, {
          method: 'PATCH',
          body: { status: newStatus },
          suppressErrorLog: true,
        });
      } catch (err) {
        if (!(err && err.status === 404)) {
          throw err;
        }
        console.warn('[anulaciones] /orders/:id devolvió 404, probando /orders/:id/status');

        try {
          return await alSaharaFetch(
            `/orders/${encodeURIComponent(orderId)}/status`,
            {
              method: 'PATCH',
              body: { status: newStatus },
              suppressErrorLog: true,
            }
          );
        } catch (err2) {
          if (!(err2 && err2.status === 404)) {
            throw err2;
          }
          console.warn('[anulaciones] /orders/:id/status devolvió 404, probando PATCH /orders');

          return await alSaharaFetch('/orders', {
            method: 'PATCH',
            body: {
              id: orderId,
              orderId: orderId,
              status: newStatus,
            },
          });
        }
      }
    }

    async function handleChangeStatus(order, newStatus) {
      const orderId = getOrderId(order);
      if (!orderId) {
        alert('No se puede actualizar una orden sin ID válido.');
        return;
      }

      const statusInfo   = mapStatus(newStatus);
      const actionLabel =
        newStatus === 'cancelled'
          ? 'anular'
          : newStatus === 'refunded'
          ? 'reembolsar'
          : 'actualizar';

      const codeForDisplay = getOrderCode(order);

      const confirmMsg =
        `¿Seguro que deseas ${actionLabel} la orden "${codeForDisplay}" (${formatCLP(order.total)})?\n` +
        `Nuevo estado: ${statusInfo.label}`;

      if (!window.confirm(confirmMsg)) return;

      try {
        const updated = await patchOrderStatus(orderId, newStatus);
        await loadOrders();
      } catch (err) {
        console.error('Error actualizando estado de la orden', err);
        if (err && (err.status === 401 || err.status === 403)) {
          clearAuthSession && clearAuthSession();
          window.location.href = 'login.html';
        } else {
          alert(
            (err && err.message) ||
            'No se pudo actualizar el estado de la orden (ruta PATCH no encontrada).'
          );
        }
      }
    }

    async function loadOrders() {
      const user = getStoredUser && getStoredUser();
      if (!user || user.role !== 'admin') {
        showNotAdminMessage();
        return;
      }

      if (!alSaharaFetch) {
        showErrorMessage('El cliente de API no está disponible.');
        return;
      }

      try {
        const data = await alSaharaFetch('/orders', { method: 'GET' });
        const all  = Array.isArray(data) ? data : [];

        const candidates = all.filter((o) =>
          VISIBLE_STATUSES.includes((o.status || '').toLowerCase())
        );

        renderRows(candidates);
      } catch (err) {
        console.error('Error cargando órdenes para anulaciones', err);
        if (err && (err.status === 401 || err.status === 403)) {
          clearAuthSession && clearAuthSession();
          window.location.href = 'login.html';
        } else {
          showErrorMessage(
            'No se pudieron cargar las órdenes. Intenta nuevamente más tarde.'
          );
        }
      }
    }

    document.addEventListener('DOMContentLoaded', loadOrders);
  })();
</script>
